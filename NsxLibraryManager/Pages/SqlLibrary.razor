@page "/sqllibrary"
@using NsxLibraryManager.Utils
@using TitleModel = NsxLibraryManager.Models.NsxLibrary.Title;

<PageTitle>Nsx Library Manager</PageTitle>
<RadzenTabs Change="@TabOnChange" @bind-SelectedIndex="@_selectedTabIndex">
    <Tabs>
        <RadzenStack Orientation="Orientation.Vertical" AlignItems="AlignItems.Normal" Wrap="FlexWrap.NoWrap" Gap="1rem">
            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Normal" Wrap="FlexWrap.NoWrap" Gap="1rem">
                <RadzenRow Style="width: 100%">
                    <RadzenColumn Size="6">
                        <RadzenText TextStyle="TextStyle.Subtitle1">Library Location: <strong>@_libraryPath</strong></RadzenText>
                    </RadzenColumn>
                    <RadzenColumn Size="6" Style="text-align: right">
                        <RadzenText TextStyle="TextStyle.Subtitle1"> <strong>@_baseCount</strong> Games, <strong>@_patchCount</strong> Updates and <strong>@_dlcCount</strong> DLCs in library </RadzenText>
                    </RadzenColumn>
                </RadzenRow>
            </RadzenStack>

            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Wrap="FlexWrap.Wrap" Gap="1rem">
                <RadzenDataGrid @ref="_grid" @bind-Settings="@Settings" LoadSettings="@LoadSettings"  Data="@_libraryTitles" LoadData="@LoadData"
                                PageSize="@_pageSize" PageSizeOptions="@_pageSizeOptions" PageSizeChanged="@(args => _pageSize = args)"
                                Count="@_count"  IsLoading="@_isLoading" AllowSorting="true" AllowPaging="true"
                                AllowFiltering="true" FilterMode="FilterMode.Advanced" FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                AllowColumnResize="true" PagerHorizontalAlign="HorizontalAlign.Center" ColumnWidth="200px" AllowColumnPicking="true"
                                ShowPagingSummary="true" style="height: 95vh">
                    <HeaderTemplate>
                        <RadzenButton Click="@(args => RefreshLibrary())" Text="Refresh Library" ButtonStyle="ButtonStyle.Primary" class=".rz-shadow-2"/>
                        <RadzenButton Click="@(args => ReloadLibrary())" Text="Reload Library" ButtonStyle="ButtonStyle.Danger" class=".rz-shadow-2"/>
                        <RadzenText TextStyle="TextStyle.Caption">Last updated @_lastUpdated</RadzenText>

                    </HeaderTemplate>
                    <Columns>
                        <RadzenDataGridColumn TItem="TitleModel" Property="ApplicationId" Title="Title Id" Width="150px"/>
                        <RadzenDataGridColumn TItem="TitleModel" Property="TitleName" Title="Name" Width="300px">
                            <Template Context="libraryTitle">
                                <RadzenLink href="javascript:void(0)" Text="@libraryTitle.TitleName" @onclick="_ => OpenDetails(libraryTitle)"/>
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="TitleModel" Property="Version" Title="Version" Visible="false"/>
                        <RadzenDataGridColumn TItem="TitleModel" Property="Publisher" Title="Publisher"/>
                        <RadzenDataGridColumn TItem="TitleModel" Property="ContentType" Title="Type" Width="80px"/>
                        <RadzenDataGridColumn TItem="TitleModel" Property="PackageType" Title="Package Type" Width="130px"/>
                        <RadzenDataGridColumn TItem="TitleModel" Property="FileName" Title="Filename"/>
                        <RadzenDataGridColumn TItem="TitleModel" Property="Size" Title="Size" Width="100px">
                            <Template Context="libraryTitle">
                                @if (libraryTitle.Size != null)
                                {
                                    var sizeInBytes = libraryTitle.Size ?? 0;
                                    @sizeInBytes.ToHumanReadableBytes()
                                }
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="TitleModel" Property="ReleaseDate" Title="Release Date" FormatString="{0:d}" Width="110px"/>
                        <RadzenDataGridColumn TItem="TitleModel" Property="LastWriteTime" Title="Date Modified" FormatString="{0:d}" Width="110px"/>
                        <RadzenDataGridColumn TItem="TitleModel" Property="NumberOfPlayers" Title="Players" Width="50px" Visible="false"/>
                        <RadzenDataGridColumn TItem="TitleModel" Property="UpdatesCount" Title="Available Version" Filterable="false" Width="50px"/>
                        <RadzenDataGridColumn TItem="TitleModel" Property="OwnedUpdates" Title="Latest Update" Filterable="false" Width="50px" Sortable="false" />
                        <RadzenDataGridColumn TItem="TitleModel" Property="DlcCount" Title="Available DLC Count" Filterable="false" Width="50px" Sortable="false" />
                        <RadzenDataGridColumn TItem="TitleModel" Property="OwnedDlcs" Title="Owned DLC Count" Filterable="false" Width="50px" Sortable="false" />
                    </Columns>
                </RadzenDataGrid>
            </RadzenStack>
        </RadzenStack>
    </Tabs>
</RadzenTabs>